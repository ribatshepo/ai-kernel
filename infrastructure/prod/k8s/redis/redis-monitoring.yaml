apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: redis
  namespace: aikernel
  labels:
    app: redis
    component: cache
spec:
  selector:
    matchLabels:
      app: redis
      component: cache
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: redis-alerts
  namespace: aikernel
  labels:
    app: redis
    component: cache
    prometheus: main
spec:
  groups:
    - name: redis
      interval: 30s
      rules:
        - alert: RedisDown
          expr: redis_up == 0
          for: 5m
          labels:
            severity: critical
            component: cache
          annotations:
            summary: "Redis instance is down"
            description: "Redis instance {{ $labels.instance }} has been down for more than 5 minutes"

        - alert: RedisHighMemoryUsage
          expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
          for: 5m
          labels:
            severity: warning
            component: cache
          annotations:
            summary: "Redis memory usage is high"
            description: "Redis instance {{ $labels.instance }} is using {{ $value | humanizePercentage }} of available memory"

        - alert: RedisHighLatency
          expr: redis_commands_duration_seconds_total{cmd="ping"} / redis_commands_total{cmd="ping"} > 0.1
          for: 5m
          labels:
            severity: warning
            component: cache
          annotations:
            summary: "Redis latency is high"
            description: "Redis instance {{ $labels.instance }} has average latency of {{ $value }}s"

        - alert: RedisTooManyConnections
          expr: redis_connected_clients > 5000
          for: 5m
          labels:
            severity: warning
            component: cache
          annotations:
            summary: "Redis has too many connections"
            description: "Redis instance {{ $labels.instance }} has {{ $value }} connections"

        - alert: RedisRejectedConnections
          expr: rate(redis_rejected_connections_total[5m]) > 0
          for: 5m
          labels:
            severity: warning
            component: cache
          annotations:
            summary: "Redis is rejecting connections"
            description: "Redis instance {{ $labels.instance }} is rejecting {{ $value }} connections per second"

        - alert: RedisMasterLinkDown
          expr: redis_master_link_up == 0
          for: 2m
          labels:
            severity: critical
            component: cache
          annotations:
            summary: "Redis replica master link is down"
            description: "Redis replica {{ $labels.instance }} has lost connection to master"

        - alert: RedisKeyEvictionRate
          expr: rate(redis_evicted_keys_total[5m]) > 100
          for: 5m
          labels:
            severity: warning
            component: cache
          annotations:
            summary: "Redis key eviction rate is high"
            description: "Redis instance {{ $labels.instance }} is evicting {{ $value }} keys per second"

        - alert: RedisReplicationLag
          expr: redis_repl_offset - redis_master_repl_offset > 10000000
          for: 5m
          labels:
            severity: warning
            component: cache
          annotations:
            summary: "Redis replication lag is high"
            description: "Redis replica {{ $labels.instance }} is lagging behind master by {{ $value }} bytes"

        - alert: RedisCacheHitRateLow
          expr: rate(aikernel_cache_hits_total[10m]) / (rate(aikernel_cache_hits_total[10m]) + rate(aikernel_cache_misses_total[10m])) < 0.7
          for: 15m
          labels:
            severity: warning
            component: cache
          annotations:
            summary: "Cache hit rate is below 70%"
            description: "Cache hit rate is {{ $value | humanizePercentage }} which is below the 90% target"
