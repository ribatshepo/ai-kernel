apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-geo-routing
  namespace: kube-system
  labels:
    app: coredns
    component: geo-routing
data:
  geo.conf: |
    # Geographic routing configuration for CoreDNS
    # Routes queries to geographically closest endpoints

    # Define geographic regions
    regions {
        us-east-1 {
            cidr 10.0.0.0/16
            priority 1
        }
        us-west-2 {
            cidr 10.1.0.0/16
            priority 2
        }
        eu-west-1 {
            cidr 10.2.0.0/16
            priority 1
        }
        ap-southeast-1 {
            cidr 10.3.0.0/16
            priority 1
        }
    }

    # Geographic routing rules
    aikernel.io {
        # Route to closest region based on client IP
        geoip {
            database /etc/coredns/GeoLite2-City.mmdb
            fallback us-east-1
        }

        # Load balance within region
        loadbalance round_robin
    }

  routing-rules.yaml: |
    # Service-specific geographic routing rules
    services:
      - name: api.aikernel.io
        regions:
          - region: us-east-1
            endpoints:
              - ip: 10.0.1.10
                weight: 100
              - ip: 10.0.1.11
                weight: 100
            latency: 10ms

          - region: us-west-2
            endpoints:
              - ip: 10.1.1.10
                weight: 100
              - ip: 10.1.1.11
                weight: 100
            latency: 50ms

          - region: eu-west-1
            endpoints:
              - ip: 10.2.1.10
                weight: 100
              - ip: 10.2.1.11
                weight: 100
            latency: 100ms

          - region: ap-southeast-1
            endpoints:
              - ip: 10.3.1.10
                weight: 100
              - ip: 10.3.1.11
                weight: 100
            latency: 150ms

        routing_policy:
          type: latency
          fallback: round_robin
---
apiVersion: v1
kind: Service
metadata:
  name: api-us-east-1
  namespace: aikernel
  labels:
    app: api
    region: us-east-1
  annotations:
    external-dns.alpha.kubernetes.io/hostname: api-us-east-1.aikernel.io
    external-dns.alpha.kubernetes.io/ttl: "30"
    dns.aikernel.io/geo-region: "us-east-1"
    dns.aikernel.io/geo-priority: "1"
    dns.aikernel.io/health-check-enabled: "true"
spec:
  type: LoadBalancer
  selector:
    app: api
    region: us-east-1
  ports:
    - port: 443
      targetPort: 8443
      protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: api-us-west-2
  namespace: aikernel
  labels:
    app: api
    region: us-west-2
  annotations:
    external-dns.alpha.kubernetes.io/hostname: api-us-west-2.aikernel.io
    external-dns.alpha.kubernetes.io/ttl: "30"
    dns.aikernel.io/geo-region: "us-west-2"
    dns.aikernel.io/geo-priority: "2"
    dns.aikernel.io/health-check-enabled: "true"
spec:
  type: LoadBalancer
  selector:
    app: api
    region: us-west-2
  ports:
    - port: 443
      targetPort: 8443
      protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: api-eu-west-1
  namespace: aikernel
  labels:
    app: api
    region: eu-west-1
  annotations:
    external-dns.alpha.kubernetes.io/hostname: api-eu-west-1.aikernel.io
    external-dns.alpha.kubernetes.io/ttl: "30"
    dns.aikernel.io/geo-region: "eu-west-1"
    dns.aikernel.io/geo-priority: "1"
    dns.aikernel.io/health-check-enabled: "true"
spec:
  type: LoadBalancer
  selector:
    app: api
    region: eu-west-1
  ports:
    - port: 443
      targetPort: 8443
      protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: api-ap-southeast-1
  namespace: aikernel
  labels:
    app: api
    region: ap-southeast-1
  annotations:
    external-dns.alpha.kubernetes.io/hostname: api-ap-southeast-1.aikernel.io
    external-dns.alpha.kubernetes.io/ttl: "30"
    dns.aikernel.io/geo-region: "ap-southeast-1"
    dns.aikernel.io/geo-priority: "1"
    dns.aikernel.io/health-check-enabled: "true"
spec:
  type: LoadBalancer
  selector:
    app: api
    region: ap-southeast-1
  ports:
    - port: 443
      targetPort: 8443
      protocol: TCP
---
# Traffic Manager for Geographic Routing
apiVersion: v1
kind: ConfigMap
metadata:
  name: traffic-manager-config
  namespace: kube-system
  labels:
    app: traffic-manager
data:
  config.yaml: |
    # Traffic Manager Configuration
    routing:
      strategy: latency_based
      fallback: geographic_proximity

    health:
      check_interval: 10s
      failure_threshold: 3
      remove_delay: 30s

    regions:
      - name: us-east-1
        priority: 1
        weight: 100
        max_latency: 50ms

      - name: us-west-2
        priority: 2
        weight: 80
        max_latency: 100ms

      - name: eu-west-1
        priority: 1
        weight: 100
        max_latency: 150ms

      - name: ap-southeast-1
        priority: 1
        weight: 100
        max_latency: 200ms

    dns:
      ttl: 30
      update_interval: 30s
