apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-custom
  namespace: kube-system
  labels:
    app: coredns
    component: dns
data:
  Corefile: |
    # Custom CoreDNS configuration for AI-Kernel
    # Cluster domain configuration
    cluster.local:53 {
        errors
        health {
            lameduck 5s
        }
        ready

        # Kubernetes plugin for service discovery
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl 30
        }

        # Prometheus metrics
        prometheus :9153

        # Forward to upstream DNS
        forward . /etc/resolv.conf {
            max_concurrent 1000
        }

        # DNS caching with TTL respect
        cache 30 {
            success 9984 30
            denial 9984 30
        }

        # Load balancing
        loadbalance round_robin

        # Loop detection
        loop

        # Automatic reload on config changes
        reload
    }

    # AI-Kernel specific domain
    aikernel.local:53 {
        errors

        # Custom service definitions
        file /etc/coredns/aikernel.db aikernel.local

        # Health-aware DNS plugin
        health_check {
            path /health
            port 8080
        }

        prometheus :9153

        cache 30

        loadbalance round_robin

        reload
    }

    # Forward all other queries
    .:53 {
        errors
        health {
            lameduck 5s
        }
        ready

        # Prometheus metrics
        prometheus :9153

        # Forward to upstream DNS with retry
        forward . 8.8.8.8 8.8.4.4 1.1.1.1 {
            max_concurrent 1000
            expire 30s
            policy sequential
            health_check 5s
        }

        # Cache with 30-second TTL
        cache 30 {
            success 9984 30
            denial 9984 30
            prefetch 10 60s
        }

        # Load balancing for high availability
        loadbalance round_robin

        # Loop detection
        loop

        # Automatic reload
        reload
    }

  aikernel.db: |
    ; AI-Kernel custom zone file
    $ORIGIN aikernel.local.
    $TTL 30

    @       IN      SOA     ns1.aikernel.local. admin.aikernel.local. (
                            2024010601  ; Serial
                            3600        ; Refresh
                            1800        ; Retry
                            604800      ; Expire
                            30 )        ; Minimum TTL

    ; Name servers
    @       IN      NS      ns1.aikernel.local.
    @       IN      NS      ns2.aikernel.local.

    ; A records for internal services
    ns1     IN      A       10.96.0.10
    ns2     IN      A       10.96.0.11
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-health-plugin
  namespace: kube-system
  labels:
    app: coredns
    component: health-check
data:
  health-check.conf: |
    # Health-aware DNS configuration
    # Integrates with Kubernetes endpoints for health status

    health_endpoints {
        # Check endpoint health via Kubernetes API
        kubernetes_endpoints true

        # Remove unhealthy endpoints within 30 seconds
        health_check_interval 10s
        failure_threshold 3

        # Only return healthy endpoints
        filter_unhealthy true
    }
