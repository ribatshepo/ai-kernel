apiVersion: v1
kind: ServiceMonitor
metadata:
  name: coredns-custom
  namespace: kube-system
  labels:
    app: coredns
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: coredns
      component: dns
  endpoints:
    - port: metrics
      interval: 15s
      scrapeTimeout: 10s
      path: /metrics
---
apiVersion: v1
kind: ServiceMonitor
metadata:
  name: external-dns
  namespace: kube-system
  labels:
    app: external-dns
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: external-dns
  endpoints:
    - port: metrics
      interval: 30s
      scrapeTimeout: 10s
---
apiVersion: v1
kind: ServiceMonitor
metadata:
  name: dns-health-controller
  namespace: kube-system
  labels:
    app: dns-health-controller
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: dns-health-controller
  endpoints:
    - port: metrics
      interval: 15s
      scrapeTimeout: 10s
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dns-grafana-dashboards
  namespace: kube-system
  labels:
    app: dns
    grafana_dashboard: "1"
data:
  dns-dashboard.json: |
    {
      "dashboard": {
        "title": "DNS Service Discovery",
        "panels": [
          {
            "title": "DNS Query Rate",
            "targets": [
              {
                "expr": "sum(rate(coredns_dns_requests_total[5m])) by (type)"
              }
            ]
          },
          {
            "title": "DNS Query Latency (p99)",
            "targets": [
              {
                "expr": "histogram_quantile(0.99, sum(rate(coredns_dns_request_duration_seconds_bucket[5m])) by (le))"
              }
            ]
          },
          {
            "title": "DNS Errors",
            "targets": [
              {
                "expr": "sum(rate(coredns_dns_responses_total{rcode!~\"NOERROR|NXDOMAIN\"}[5m]))"
              }
            ]
          },
          {
            "title": "Cache Hit Rate",
            "targets": [
              {
                "expr": "sum(rate(coredns_cache_hits_total[5m])) / (sum(rate(coredns_cache_hits_total[5m])) + sum(rate(coredns_cache_misses_total[5m])))"
              }
            ]
          },
          {
            "title": "Healthy Endpoints",
            "targets": [
              {
                "expr": "dns_healthy_endpoints"
              }
            ]
          },
          {
            "title": "Unhealthy Endpoints",
            "targets": [
              {
                "expr": "dns_unhealthy_endpoints"
              }
            ]
          },
          {
            "title": "Health Check Duration",
            "targets": [
              {
                "expr": "histogram_quantile(0.99, sum(rate(dns_health_check_duration_seconds_bucket[5m])) by (le, namespace, service))"
              }
            ]
          },
          {
            "title": "External DNS Sync",
            "targets": [
              {
                "expr": "rate(external_dns_registry_endpoints_total[5m])"
              }
            ]
          }
        ]
      }
    }
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: dns-alerts
  namespace: kube-system
  labels:
    app: dns
    prometheus: kube-prometheus
spec:
  groups:
    - name: dns
      interval: 30s
      rules:
        - alert: CoreDNSDown
          expr: up{job="coredns-custom"} == 0
          for: 1m
          labels:
            severity: critical
            component: dns
          annotations:
            summary: "CoreDNS is down"
            description: "CoreDNS instance {{ $labels.pod }} is down"

        - alert: HighDNSErrorRate
          expr: |
            (
              sum(rate(coredns_dns_responses_total{rcode!~"NOERROR|NXDOMAIN"}[5m]))
              /
              sum(rate(coredns_dns_responses_total[5m]))
            ) > 0.05
          for: 5m
          labels:
            severity: warning
            component: dns
          annotations:
            summary: "High DNS error rate"
            description: "DNS error rate is {{ $value | humanizePercentage }}"

        - alert: HighDNSLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(coredns_dns_request_duration_seconds_bucket[5m])) by (le)
            ) > 0.1
          for: 5m
          labels:
            severity: warning
            component: dns
          annotations:
            summary: "High DNS query latency"
            description: "DNS p99 latency is {{ $value }}s"

        - alert: LowCacheHitRate
          expr: |
            (
              sum(rate(coredns_cache_hits_total[5m]))
              /
              (sum(rate(coredns_cache_hits_total[5m])) + sum(rate(coredns_cache_misses_total[5m])))
            ) < 0.5
          for: 10m
          labels:
            severity: warning
            component: dns
          annotations:
            summary: "Low DNS cache hit rate"
            description: "DNS cache hit rate is {{ $value | humanizePercentage }}"

        - alert: HighUnhealthyEndpoints
          expr: dns_unhealthy_endpoints > 5
          for: 5m
          labels:
            severity: warning
            component: dns
          annotations:
            summary: "High number of unhealthy endpoints"
            description: "{{ $value }} endpoints are unhealthy"

        - alert: DNSHealthControllerDown
          expr: up{job="dns-health-controller"} == 0
          for: 2m
          labels:
            severity: critical
            component: dns
          annotations:
            summary: "DNS Health Controller is down"
            description: "DNS Health Controller is not running"

        - alert: ExternalDNSSyncFailure
          expr: rate(external_dns_registry_errors_total[5m]) > 0
          for: 5m
          labels:
            severity: warning
            component: dns
          annotations:
            summary: "External DNS sync failures"
            description: "External DNS is experiencing sync failures"

        - alert: CoreDNSPodCrashLooping
          expr: rate(kube_pod_container_status_restarts_total{namespace="kube-system",pod=~"coredns-.*"}[15m]) > 0
          for: 5m
          labels:
            severity: critical
            component: dns
          annotations:
            summary: "CoreDNS pod is crash looping"
            description: "CoreDNS pod {{ $labels.pod }} is crash looping"
---
# DNS Query Tester Job for monitoring
apiVersion: batch/v1
kind: CronJob
metadata:
  name: dns-query-tester
  namespace: kube-system
  labels:
    app: dns
    component: monitoring
spec:
  schedule: "*/5 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: dns-query-tester
        spec:
          restartPolicy: OnFailure
          containers:
            - name: tester
              image: busybox:1.36
              command:
                - /bin/sh
                - -c
                - |
                  echo "Testing DNS resolution..."

                  # Test internal cluster DNS
                  nslookup kubernetes.default.svc.cluster.local || exit 1

                  # Test external DNS
                  nslookup google.com || exit 1

                  # Test aikernel domains
                  nslookup api.aikernel.local || echo "Warning: api.aikernel.local not found"

                  # Measure query latency
                  start=$(date +%s%N)
                  nslookup kubernetes.default.svc.cluster.local > /dev/null
                  end=$(date +%s%N)
                  latency=$((($end - $start) / 1000000))
                  echo "Query latency: ${latency}ms"

                  # Check if latency is acceptable
                  if [ $latency -gt 100 ]; then
                    echo "Warning: High DNS latency detected"
                    exit 1
                  fi

                  echo "DNS tests passed"
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  cpu: 50m
                  memory: 64Mi
