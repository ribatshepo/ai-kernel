apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-config
  namespace: aikernel-data
  labels:
    app: elasticsearch
    component: config
data:
  elasticsearch.yml: |
    cluster.name: aikernel-search
    network.host: 0.0.0.0

    # Discovery settings
    discovery.seed_hosts:
      - elasticsearch-master-0.elasticsearch-master.aikernel-data.svc.cluster.local
      - elasticsearch-master-1.elasticsearch-master.aikernel-data.svc.cluster.local
      - elasticsearch-master-2.elasticsearch-master.aikernel-data.svc.cluster.local
    cluster.initial_master_nodes:
      - elasticsearch-master-0
      - elasticsearch-master-1
      - elasticsearch-master-2

    # Node roles are set via environment variables

    # Security settings
    xpack.security.enabled: true
    xpack.security.transport.ssl.enabled: true
    xpack.security.transport.ssl.verification_mode: certificate
    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12

    xpack.security.http.ssl.enabled: true
    xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12

    # Monitoring
    xpack.monitoring.enabled: true
    xpack.monitoring.collection.enabled: true

    # Index lifecycle management
    xpack.ilm.enabled: true

    # Performance tuning
    indices.memory.index_buffer_size: 20%
    indices.queries.cache.size: 10%

    # Thread pools
    thread_pool.write.queue_size: 1000
    thread_pool.search.queue_size: 1000

  jvm.options: |
    ## JVM configuration

    # Xms represents the initial size of total heap space
    # Xmx represents the maximum size of total heap space
    -Xms2g
    -Xmx2g

    # Disable explicit GC
    -XX:+DisableExplicitGC

    # G1GC Configuration
    -XX:+UseG1GC
    -XX:G1ReservePercent=25
    -XX:InitiatingHeapOccupancyPercent=30

    # DNS cache settings
    -Des.networkaddress.cache.ttl=60
    -Des.networkaddress.cache.negative.ttl=10

    # Pre-touch memory pages
    -XX:+AlwaysPreTouch

    # Ensure UTF-8 encoding by default
    -Dfile.encoding=UTF-8

    # Disable JVM default error file
    -XX:ErrorFile=/var/log/elasticsearch/hs_err_pid%p.log

    # HeapDumpPath
    -XX:HeapDumpPath=/var/log/elasticsearch/heapdump.hprof

    # GC logging
    -Xlog:gc*,gc+age=trace,safepoint:file=/var/log/elasticsearch/gc.log:utctime,pid,tags:filecount=32,filesize=64m
