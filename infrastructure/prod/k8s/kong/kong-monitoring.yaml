apiVersion: v1
kind: ServiceMonitor
metadata:
  name: kong-gateway
  namespace: kong
  labels:
    app: kong
    component: gateway
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: kong
      component: gateway
  endpoints:
    - port: status
      path: /metrics
      interval: 15s
      scrapeTimeout: 10s
      scheme: http
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-grafana-dashboard
  namespace: kong
  labels:
    app: kong
    component: gateway
    grafana_dashboard: "1"
data:
  kong-dashboard.json: |
    {
      "dashboard": {
        "title": "Kong API Gateway",
        "panels": [
          {
            "title": "Request Rate",
            "targets": [
              {
                "expr": "sum(rate(kong_http_requests_total[5m])) by (service)"
              }
            ]
          },
          {
            "title": "Request Latency (p99)",
            "targets": [
              {
                "expr": "histogram_quantile(0.99, sum(rate(kong_latency_bucket[5m])) by (le, service))"
              }
            ]
          },
          {
            "title": "Error Rate",
            "targets": [
              {
                "expr": "sum(rate(kong_http_requests_total{code=~\"5..\"}[5m])) / sum(rate(kong_http_requests_total[5m]))"
              }
            ]
          },
          {
            "title": "Bandwidth",
            "targets": [
              {
                "expr": "sum(rate(kong_bandwidth_bytes[5m])) by (type)"
              }
            ]
          },
          {
            "title": "Active Connections",
            "targets": [
              {
                "expr": "sum(kong_nginx_connections_total) by (state)"
              }
            ]
          },
          {
            "title": "Upstream Health",
            "targets": [
              {
                "expr": "kong_upstream_target_health"
              }
            ]
          }
        ]
      }
    }
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kong-alerts
  namespace: kong
  labels:
    app: kong
    component: gateway
    prometheus: kube-prometheus
spec:
  groups:
    - name: kong-gateway
      interval: 30s
      rules:
        - alert: KongHighErrorRate
          expr: |
            (
              sum(rate(kong_http_requests_total{code=~"5.."}[5m]))
              /
              sum(rate(kong_http_requests_total[5m]))
            ) > 0.05
          for: 5m
          labels:
            severity: warning
            component: kong-gateway
          annotations:
            summary: "Kong Gateway high error rate"
            description: "Kong is experiencing {{ $value | humanizePercentage }} error rate for 5 minutes"

        - alert: KongHighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(kong_latency_bucket[5m])) by (le, service)
            ) > 1000
          for: 5m
          labels:
            severity: warning
            component: kong-gateway
          annotations:
            summary: "Kong Gateway high latency"
            description: "Kong p99 latency is {{ $value }}ms for service {{ $labels.service }}"

        - alert: KongDown
          expr: up{job="kong-gateway"} == 0
          for: 1m
          labels:
            severity: critical
            component: kong-gateway
          annotations:
            summary: "Kong Gateway is down"
            description: "Kong instance {{ $labels.pod }} is down"

        - alert: KongHighConnectionUsage
          expr: |
            (
              kong_nginx_connections_total{state="active"}
              /
              kong_nginx_connections_total{state="accepted"}
            ) > 0.8
          for: 5m
          labels:
            severity: warning
            component: kong-gateway
          annotations:
            summary: "Kong high connection usage"
            description: "Kong is using {{ $value | humanizePercentage }} of connections"

        - alert: KongUpstreamUnhealthy
          expr: kong_upstream_target_health == 0
          for: 2m
          labels:
            severity: warning
            component: kong-gateway
          annotations:
            summary: "Kong upstream unhealthy"
            description: "Upstream {{ $labels.upstream }} target {{ $labels.target }} is unhealthy"
