apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-plugin-configs
  namespace: kong
  labels:
    app: kong
    component: gateway
data:
  # Rate Limiting Plugin Configuration
  rate-limiting.yaml: |
    name: rate-limiting
    config:
      second: null
      minute: 100
      hour: 10000
      day: 100000
      month: null
      year: null
      limit_by: consumer
      policy: redis
      fault_tolerant: true
      hide_client_headers: false
      redis_host: redis.aikernel-infrastructure.svc.cluster.local
      redis_port: 6379
      redis_database: 1
      redis_timeout: 2000

  # JWT Authentication Plugin
  jwt.yaml: |
    name: jwt
    config:
      uri_param_names:
        - jwt
      cookie_names: []
      claims_to_verify:
        - exp
        - nbf
      key_claim_name: iss
      secret_is_base64: false
      maximum_expiration: 86400
      run_on_preflight: true

  # Request Size Limiting
  request-size-limiting.yaml: |
    name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes
      require_content_length: true

  # IP Restriction (DDoS Protection)
  ip-restriction.yaml: |
    name: ip-restriction
    config:
      allow: null
      deny: null
      status: 403
      message: "Your IP address is not allowed"

  # Request Termination (Circuit Breaker)
  request-termination.yaml: |
    name: request-termination
    config:
      status_code: 503
      message: "Service temporarily unavailable"
      content_type: "application/json"
      body: '{"error":"Service temporarily unavailable","code":503}'
      trigger: null

  # Bot Detection
  bot-detection.yaml: |
    name: bot-detection
    config:
      allow:
        - googlebot
        - bingbot
      deny:
        - curl
        - scrapy
      rules: {}

  # Request Validation
  request-validation.yaml: |
    name: request-validator
    config:
      version: kong_bundled
      body_schema: null
      parameter_schema: []
      allowed_content_types:
        - application/json
        - application/xml
        - application/x-www-form-urlencoded
        - multipart/form-data

  # Canary Release
  canary.yaml: |
    name: canary
    config:
      start: 0
      duration: 3600
      percentage: 10
      steps: 10
      upstream_host: null
      upstream_fallback: true
      upstream_port: 8000
      hash: consumer

  # HTTP Log to ELK
  http-log.yaml: |
    name: http-log
    config:
      http_endpoint: http://logstash.aikernel-infrastructure.svc.cluster.local:8080
      method: POST
      content_type: application/json
      timeout: 10000
      keepalive: 60000
      retry_count: 10
      queue_size: 1000
      flush_timeout: 2
      headers:
        Content-Type: application/json
        X-Log-Source: kong-gateway

  # gRPC Gateway
  grpc-gateway.yaml: |
    name: grpc-gateway
    config:
      proto: /etc/kong/protos/service.proto

  # gRPC Web
  grpc-web.yaml: |
    name: grpc-web
    config:
      proto: /etc/kong/protos/service.proto
      allow_origin_header: "*"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-rate-limit-tiers
  namespace: kong
  labels:
    app: kong
    component: gateway
data:
  tiers.yaml: |
    # Rate limit tiers for different consumer types
    tiers:
      free:
        minute: 10
        hour: 100
        day: 1000
      basic:
        minute: 100
        hour: 1000
        day: 10000
      premium:
        minute: 1000
        hour: 10000
        day: 100000
      enterprise:
        minute: 10000
        hour: 100000
        day: 1000000
---
# Network Policy for Kong
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kong-gateway
  namespace: kong
spec:
  podSelector:
    matchLabels:
      app: kong
      component: gateway
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow external traffic on proxy ports
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8443
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: aikernel-infrastructure
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 8100
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow PostgreSQL
    - to:
        - namespaceSelector:
            matchLabels:
              name: aikernel-infrastructure
        - podSelector:
            matchLabels:
              app: postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Allow Redis
    - to:
        - namespaceSelector:
            matchLabels:
              name: aikernel-infrastructure
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    # Allow Catalog API
    - to:
        - namespaceSelector:
            matchLabels:
              name: aikernel
        - podSelector:
            matchLabels:
              app: catalog-api
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8443
    # Allow all internal services (controlled by service mesh)
    - to:
        - namespaceSelector:
            matchLabels:
              istio-injection: enabled
      ports:
        - protocol: TCP
          port: 1-65535
