apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: kong
  labels:
    app: kong
    component: gateway
data:
  # Kong Database Configuration
  KONG_DATABASE: "postgres"
  KONG_PG_HOST: "postgresql.aikernel-infrastructure.svc.cluster.local"
  KONG_PG_PORT: "5432"
  KONG_PG_DATABASE: "kong"
  KONG_PG_USER: "kong"

  # Proxy Configuration
  KONG_PROXY_LISTEN: "0.0.0.0:8000, 0.0.0.0:8443 http2 ssl"
  KONG_ADMIN_LISTEN: "127.0.0.1:8001, 127.0.0.1:8444 ssl"
  KONG_STATUS_LISTEN: "0.0.0.0:8100"

  # TLS Configuration
  KONG_SSL_CERT: "/etc/kong/certs/tls.crt"
  KONG_SSL_CERT_KEY: "/etc/kong/certs/tls.key"
  KONG_SSL_PROTOCOLS: "TLSv1.3"
  KONG_SSL_PREFER_SERVER_CIPHERS: "on"
  KONG_SSL_CIPHERS: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"

  # Upstream Configuration
  KONG_NGINX_HTTP_UPSTREAM_KEEPALIVE: "60"
  KONG_NGINX_HTTP_UPSTREAM_KEEPALIVE_REQUESTS: "100"
  KONG_NGINX_HTTP_UPSTREAM_KEEPALIVE_TIMEOUT: "60s"

  # Performance Configuration
  KONG_NGINX_WORKER_PROCESSES: "auto"
  KONG_NGINX_WORKER_CONNECTIONS: "10000"
  KONG_MEM_CACHE_SIZE: "128m"

  # Logging Configuration
  KONG_LOG_LEVEL: "info"
  KONG_PROXY_ACCESS_LOG: "/dev/stdout"
  KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
  KONG_PROXY_ERROR_LOG: "/dev/stderr"
  KONG_ADMIN_ERROR_LOG: "/dev/stderr"
  KONG_ACCESS_LOG_FORMAT: '{"remote_addr":"$remote_addr","time_local":"$time_local","request":"$request","status":"$status","body_bytes_sent":"$body_bytes_sent","request_time":"$request_time","http_referrer":"$http_referer","http_user_agent":"$http_user_agent","request_id":"$request_id","upstream_addr":"$upstream_addr","upstream_response_time":"$upstream_response_time","trace_id":"$http_x_b3_traceid"}'

  # Trust Configuration
  KONG_REAL_IP_HEADER: "X-Forwarded-For"
  KONG_TRUSTED_IPS: "0.0.0.0/0,::/0"
  KONG_REAL_IP_RECURSIVE: "on"

  # Plugin Configuration
  KONG_PLUGINS: "bundled,rate-limiting,jwt,cors,request-transformer,response-transformer,prometheus,opentelemetry"

  # Observability
  KONG_TRACING: "on"
  KONG_TRACING_SAMPLING_RATE: "0.01"

  # Health Checks
  KONG_NGINX_PROXY_LARGE_CLIENT_HEADER_BUFFERS: "16 128k"
  KONG_CLIENT_BODY_BUFFER_SIZE: "8k"
  KONG_CLIENT_MAX_BODY_SIZE: "10m"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
  namespace: kong
  labels:
    app: kong
    component: gateway
data:
  kong.yaml: |
    _format_version: "3.0"

    # Global settings
    _info:
      select_tags:
        - aikernel

    # Services and Routes will be managed dynamically via catalog integration
    services: []
    routes: []

    # Global Plugins
    plugins:
      - name: prometheus
        enabled: true
        config:
          per_consumer: true

      - name: correlation-id
        enabled: true
        config:
          header_name: X-Request-ID
          generator: uuid
          echo_downstream: true

      - name: request-transformer
        enabled: true
        config:
          add:
            headers:
              - "X-Kong-Request-ID:$(headers['X-Request-ID'])"
              - "X-Forwarded-Proto:https"

      - name: response-transformer
        enabled: true
        config:
          add:
            headers:
              - "X-Content-Type-Options:nosniff"
              - "X-Frame-Options:DENY"
              - "X-XSS-Protection:1; mode=block"
              - "Strict-Transport-Security:max-age=31536000; includeSubDomains"
              - "Content-Security-Policy:default-src 'self'"

      - name: cors
        enabled: true
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
            - X-Request-ID
          exposed_headers:
            - X-Request-ID
          credentials: true
          max_age: 3600

      - name: opentelemetry
        enabled: true
        config:
          endpoint: "http://jaeger-collector.aikernel-infrastructure.svc.cluster.local:4318/v1/traces"
          resource_attributes:
            service.name: "kong-gateway"
          headers:
            X-Kong-Request-ID: "request_id"
