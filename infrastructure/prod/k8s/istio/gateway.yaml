# Main ingress gateway for external traffic
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: aikernel-gateway
  namespace: aikernel
spec:
  selector:
    istio: ingressgateway
  servers:
  # HTTPS traffic
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: aikernel-tls-cert
      minProtocolVersion: TLSV1_3
      cipherSuites:
      - TLS_AES_128_GCM_SHA256
      - TLS_AES_256_GCM_SHA384
      - TLS_CHACHA20_POLY1305_SHA256
    hosts:
    - "*.aikernel.io"
    - "api.aikernel.io"
    - "catalog.aikernel.io"
  # HTTP to HTTPS redirect
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*.aikernel.io"
    tls:
      httpsRedirect: true
---
# Virtual service for catalog API
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: catalog-api
  namespace: aikernel
spec:
  hosts:
  - "catalog.aikernel.io"
  - "catalog-api.aikernel.svc.cluster.local"
  gateways:
  - aikernel-gateway
  - mesh
  http:
  - name: "catalog-api-routes"
    match:
    - uri:
        prefix: "/api/v1/catalog"
    route:
    - destination:
        host: catalog-api.aikernel.svc.cluster.local
        port:
          number: 80
      weight: 100
    retries:
      attempts: 3
      perTryTimeout: 2s
      retryOn: "5xx,reset,connect-failure,refused-stream"
    timeout: 10s
    corsPolicy:
      allowOrigins:
      - exact: "https://console.aikernel.io"
      - prefix: "https://*.aikernel.io"
      allowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
      - OPTIONS
      allowHeaders:
      - "authorization"
      - "content-type"
      - "x-request-id"
      - "x-correlation-id"
      maxAge: "24h"
      allowCredentials: true
    headers:
      request:
        add:
          x-forwarded-proto: "https"
        remove:
        - x-envoy-internal
      response:
        add:
          strict-transport-security: "max-age=31536000; includeSubDomains"
          x-content-type-options: "nosniff"
          x-frame-options: "DENY"
          x-xss-protection: "1; mode=block"
---
# Fault injection for chaos testing (disabled by default)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: catalog-api-fault-injection
  namespace: aikernel
  annotations:
    chaos.istio.io/enabled: "false"
spec:
  hosts:
  - catalog-api.aikernel.svc.cluster.local
  http:
  - match:
    - headers:
        x-chaos-test:
          exact: "true"
    fault:
      delay:
        percentage:
          value: 10
        fixedDelay: 5s
      abort:
        percentage:
          value: 5
        httpStatus: 503
    route:
    - destination:
        host: catalog-api.aikernel.svc.cluster.local
---
# Traffic mirroring for testing (disabled by default)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: catalog-api-mirror
  namespace: aikernel
  annotations:
    mirror.istio.io/enabled: "false"
spec:
  hosts:
  - catalog-api.aikernel.svc.cluster.local
  http:
  - match:
    - headers:
        x-mirror-traffic:
          exact: "true"
    route:
    - destination:
        host: catalog-api.aikernel.svc.cluster.local
        subset: v1
    mirror:
      host: catalog-api.aikernel.svc.cluster.local
      subset: v2
    mirrorPercentage:
      value: 100
