name: Infrastructure Deployment

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'infrastructure/**'
      - '.github/workflows/infrastructure-deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infrastructure/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      skip_istio:
        description: 'Skip Istio installation'
        required: false
        type: boolean
        default: false
      skip_argocd:
        description: 'Skip ArgoCD installation'
        required: false
        type: boolean
        default: false
      skip_dashboard:
        description: 'Skip Dashboard installation'
        required: false
        type: boolean
        default: false

env:
  KUBECTL_VERSION: v1.28.0
  ISTIO_VERSION: 1.20.0
  ARGOCD_VERSION: v2.9.3

jobs:
  validate:
    name: Validate Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v0.6.3/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          find infrastructure/prod/k8s -name "*.yaml" -exec kubeconform -summary -output json {} \;

      - name: Lint shell scripts
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          find infrastructure/prod/k8s -name "*.sh" -exec shellcheck {} \;

      - name: Check for secrets in manifests
        run: |
          # Ensure no hardcoded secrets (except placeholder values)
          ! grep -r "password.*[^CHANGE_ME]" infrastructure/prod/k8s/*.yaml || exit 1
          echo "✓ No hardcoded secrets found"

  plan:
    name: Plan Deployment
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Configure kubectl
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Dry-run deployment
        run: |
          cd infrastructure/prod/k8s
          DRY_RUN=true ./deploy-all.sh

      - name: Generate diff
        run: |
          cd infrastructure/prod/k8s
          kubectl diff -f . || true

  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development')
    environment:
      name: development
      url: https://dev.aikernel.io
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Configure kubectl for on-prem cluster
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DEV }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl cluster-info
          kubectl get nodes

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Configure Helm with Artifactory
        env:
          ARTIFACTORY_USER: ${{ secrets.ARTIFACTORY_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
        run: |
          # Add Artifactory Helm repository
          helm repo add aikernel-charts https://artifactory.aikernel.local/artifactory/helm-local \
            --username "${ARTIFACTORY_USER}" \
            --password "${ARTIFACTORY_PASSWORD}"

          helm repo add stable https://charts.helm.sh/stable
          helm repo update

      - name: Deploy infrastructure
        env:
          SKIP_ISTIO: ${{ github.event.inputs.skip_istio || 'false' }}
          SKIP_ARGOCD: ${{ github.event.inputs.skip_argocd || 'false' }}
          SKIP_DASHBOARD: ${{ github.event.inputs.skip_dashboard || 'false' }}
          ARTIFACTORY_USER: ${{ secrets.ARTIFACTORY_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
        run: |
          cd infrastructure/prod/k8s
          export SKIP_ISTIO=$SKIP_ISTIO
          export SKIP_ARGOCD=$SKIP_ARGOCD
          export SKIP_DASHBOARD=$SKIP_DASHBOARD
          export ARTIFACTORY_USER=$ARTIFACTORY_USER
          export ARTIFACTORY_PASSWORD=$ARTIFACTORY_PASSWORD
          ./deploy-all.sh

      - name: Wait for rollout
        run: |
          kubectl rollout status statefulset/postgres -n aikernel-data --timeout=10m
          kubectl rollout status statefulset/redis -n aikernel-data --timeout=5m
          kubectl rollout status deployment/grafana -n aikernel-monitoring --timeout=5m

      - name: Health check
        run: |
          # Check all pods are running
          kubectl get pods -A

          # Verify critical services
          kubectl wait --for=condition=ready pod -l app=postgres -n aikernel-data --timeout=5m
          kubectl wait --for=condition=ready pod -l app=redis -n aikernel-data --timeout=5m
          kubectl wait --for=condition=ready pod -l app=grafana -n aikernel-monitoring --timeout=5m

      - name: Get service endpoints
        run: |
          echo "=== LoadBalancer Services ==="
          kubectl get svc -A | grep LoadBalancer || echo "No LoadBalancer services (expected for on-prem)"

          echo "=== NodePort Services ==="
          kubectl get svc -A | grep NodePort || echo "No NodePort services"

          echo "=== Get external access points ==="
          # For on-prem, typically using NodePort or MetalLB
          kubectl get svc -n kubernetes-dashboard kubernetes-dashboard-lb -o wide || true
          kubectl get svc -n aikernel-monitoring grafana-lb -o wide || true

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** On-Premise" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Components" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n aikernel-data -o wide >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n aikernel-monitoring -o wide >> $GITHUB_STEP_SUMMARY

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.aikernel.io
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Configure kubectl for on-prem cluster
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_STAGING }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl cluster-info
          kubectl get nodes

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Configure Helm with Artifactory
        env:
          ARTIFACTORY_USER: ${{ secrets.ARTIFACTORY_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
        run: |
          helm repo add aikernel-charts https://artifactory.aikernel.local/artifactory/helm-local \
            --username "${ARTIFACTORY_USER}" \
            --password "${ARTIFACTORY_PASSWORD}"
          helm repo add stable https://charts.helm.sh/stable
          helm repo update

      - name: Deploy infrastructure
        env:
          SKIP_ISTIO: ${{ github.event.inputs.skip_istio || 'false' }}
          SKIP_ARGOCD: ${{ github.event.inputs.skip_argocd || 'false' }}
          SKIP_DASHBOARD: ${{ github.event.inputs.skip_dashboard || 'false' }}
        run: |
          cd infrastructure/prod/k8s
          export SKIP_ISTIO=$SKIP_ISTIO
          export SKIP_ARGOCD=$SKIP_ARGOCD
          export SKIP_DASHBOARD=$SKIP_DASHBOARD
          ./deploy-all.sh

      - name: Wait for rollout
        run: |
          kubectl rollout status statefulset/postgres -n aikernel-data --timeout=10m
          kubectl rollout status statefulset/redis -n aikernel-data --timeout=5m
          kubectl rollout status deployment/grafana -n aikernel-monitoring --timeout=5m

      - name: Run smoke tests
        run: |
          # Test PostgreSQL connectivity
          kubectl run pg-test --rm -i --restart=Never --image=postgres:15-alpine -- \
            psql -h postgres-primary.aikernel-data -U aikernel -c "SELECT 1;" || true

          # Test Redis connectivity
          kubectl run redis-test --rm -i --restart=Never --image=redis:7-alpine -- \
            redis-cli -h redis-master.aikernel-data PING || true

      - name: Notify deployment
        if: always()
        run: |
          # Add your notification logic here (Slack, Teams, etc.)
          echo "Deployment to staging completed with status: ${{ job.status }}"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, deploy-staging]
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://aikernel.io
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Configure kubectl for on-prem cluster
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_PROD }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl cluster-info
          kubectl get nodes

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Configure Helm with Artifactory
        env:
          ARTIFACTORY_USER: ${{ secrets.ARTIFACTORY_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
        run: |
          helm repo add aikernel-charts https://artifactory.aikernel.local/artifactory/helm-local \
            --username "${ARTIFACTORY_USER}" \
            --password "${ARTIFACTORY_PASSWORD}"
          helm repo add stable https://charts.helm.sh/stable
          helm repo update

      - name: Pre-deployment backup
        run: |
          # Backup critical data before deployment
          timestamp=$(date +%Y%m%d_%H%M%S)

          # Backup PostgreSQL
          kubectl exec postgres-0 -n aikernel-data -- \
            pg_dump -U aikernel aikernel_catalog > backup_${timestamp}.sql || true

          # Upload to backup storage (customize for your setup)
          echo "Backup created: backup_${timestamp}.sql"

      - name: Deploy infrastructure (Blue-Green)
        env:
          SKIP_ISTIO: ${{ github.event.inputs.skip_istio || 'false' }}
          SKIP_ARGOCD: ${{ github.event.inputs.skip_argocd || 'false' }}
          SKIP_DASHBOARD: ${{ github.event.inputs.skip_dashboard || 'false' }}
        run: |
          cd infrastructure/prod/k8s
          export SKIP_ISTIO=$SKIP_ISTIO
          export SKIP_ARGOCD=$SKIP_ARGOCD
          export SKIP_DASHBOARD=$SKIP_DASHBOARD
          ./deploy-all.sh

      - name: Wait for rollout
        run: |
          kubectl rollout status statefulset/postgres -n aikernel-data --timeout=15m
          kubectl rollout status statefulset/redis -n aikernel-data --timeout=10m
          kubectl rollout status statefulset/elasticsearch -n aikernel-data --timeout=15m
          kubectl rollout status deployment/grafana -n aikernel-monitoring --timeout=10m

      - name: Production health check
        run: |
          # Comprehensive health checks
          kubectl wait --for=condition=ready pod -l app=postgres -n aikernel-data --timeout=5m
          kubectl wait --for=condition=ready pod -l app=redis -n aikernel-data --timeout=5m
          kubectl wait --for=condition=ready pod -l app=elasticsearch -n aikernel-data --timeout=5m
          kubectl wait --for=condition=ready pod -l app=grafana -n aikernel-monitoring --timeout=5m
          kubectl wait --for=condition=ready pod -l app=prometheus -n aikernel-monitoring --timeout=5m

      - name: Run production smoke tests
        run: |
          # Test all critical services
          echo "Testing PostgreSQL..."
          kubectl run pg-test --rm -i --restart=Never --image=postgres:15-alpine -- \
            psql -h postgres-primary.aikernel-data -U aikernel -c "SELECT version();"

          echo "Testing Redis..."
          kubectl run redis-test --rm -i --restart=Never --image=redis:7-alpine -- \
            redis-cli -h redis-master.aikernel-data INFO server

          echo "Testing Elasticsearch..."
          kubectl run es-test --rm -i --restart=Never --image=curlimages/curl -- \
            curl -s http://elasticsearch.aikernel-data:9200/_cluster/health

      - name: Monitor deployment
        run: |
          # Monitor for 5 minutes post-deployment
          echo "Monitoring deployment for 5 minutes..."
          for i in {1..5}; do
            echo "Check $i/5..."
            kubectl get pods -A | grep -E "Error|CrashLoop|Pending" || echo "All pods healthy"
            sleep 60
          done

      - name: Notify production deployment
        if: always()
        run: |
          # Critical: Add your notification logic here
          echo "Production deployment completed with status: ${{ job.status }}"

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [deploy-production]
    environment:
      name: production
    steps:
      - name: Checkout previous version
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.before }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Configure kubectl
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_PROD }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Rollback deployments
        run: |
          # Rollback to previous version
          kubectl rollout undo statefulset/postgres -n aikernel-data
          kubectl rollout undo statefulset/redis -n aikernel-data
          kubectl rollout undo deployment/grafana -n aikernel-monitoring
          kubectl rollout undo deployment/prometheus -n aikernel-monitoring

      - name: Verify rollback
        run: |
          kubectl rollout status statefulset/postgres -n aikernel-data --timeout=10m
          kubectl get pods -A

      - name: Notify rollback
        run: |
          echo "⚠️ ROLLBACK EXECUTED - Production deployment failed and was rolled back"
