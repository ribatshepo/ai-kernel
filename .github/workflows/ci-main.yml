name: CI - Main Pipeline

on:
  push:
    branches: [main, develop, feat/*, fix/*]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  # Git Flow validation - runs once for entire pipeline
  validate-git-flow:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Validate Git Flow branch rules
        run: |
          SOURCE="${{ github.head_ref }}"
          TARGET="${{ github.base_ref }}"

          echo "========================================"
          echo "Git Flow Validation"
          echo "========================================"
          echo "Source branch: $SOURCE"
          echo "Target branch: $TARGET"
          echo ""

          # Rule 1: Only develop can merge to main
          if [[ "$TARGET" == "main" ]]; then
            if [[ "$SOURCE" != "develop" ]]; then
              echo "❌ ERROR: Only 'develop' branch can merge to 'main'"
              echo "   Current source: $SOURCE"
              exit 1
            fi
            echo "✅ SUCCESS: develop -> main merge is allowed"
          fi

          # Rule 2: Only feat/* and fix/* can merge to develop
          if [[ "$TARGET" == "develop" ]]; then
            if [[ ! "$SOURCE" =~ ^(feat|fix)/ ]]; then
              echo "❌ ERROR: Only 'feat/*' and 'fix/*' branches can merge to 'develop'"
              echo "   Current source: $SOURCE"
              exit 1
            fi
            echo "✅ SUCCESS: $SOURCE -> develop merge is allowed"
          fi

          echo ""
          echo "✅ Git Flow validation passed"

  # Project structure validation
  validate-structure:
    needs: [validate-git-flow]
    runs-on: ubuntu-latest
    if: always() && (needs.validate-git-flow.result == 'success' || needs.validate-git-flow.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate project structure
        run: |
          echo "========================================"
          echo "Project Structure Validation"
          echo "========================================"

          # Check for required directories
          required_dirs=("src" ".github")
          for dir in "${required_dirs[@]}"; do
            if [[ ! -d "$dir" ]]; then
              echo "❌ ERROR: Missing required directory: $dir"
              exit 1
            fi
            echo "✅ Found: $dir/"
          done

          # Check for at least one component
          component_count=$(find src -maxdepth 1 -type d | wc -l)
          if [[ $component_count -lt 2 ]]; then
            echo "❌ ERROR: No components found in src directory"
            exit 1
          fi
          echo "✅ Found $((component_count - 1)) components in src/"

          echo ""
          echo "✅ Project structure validation passed"

  # Call tech-specific workflows
  frontend:
    needs: [validate-structure]
    uses: ./.github/workflows/ci-frontend.yml
    if: always() && needs.validate-structure.result == 'success'

  dotnet:
    needs: [validate-structure]
    uses: ./.github/workflows/ci-dotnet.yml
    if: always() && needs.validate-structure.result == 'success'

  python:
    needs: [validate-structure]
    uses: ./.github/workflows/ci-python.yml
    if: always() && needs.validate-structure.result == 'success'

  inference:
    needs: [validate-structure]
    uses: ./.github/workflows/ci-inference.yml
    if: always() && needs.validate-structure.result == 'success'

  # Final status check
  ci-complete:
    needs: [validate-git-flow, validate-structure, frontend, dotnet, python, inference]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "========================================"
          echo "CI Pipeline Status Summary"
          echo "========================================"

          git_flow_status="${{ needs.validate-git-flow.result }}"
          structure_status="${{ needs.validate-structure.result }}"
          frontend_status="${{ needs.frontend.result }}"
          dotnet_status="${{ needs.dotnet.result }}"
          python_status="${{ needs.python.result }}"
          inference_status="${{ needs.inference.result }}"

          echo "Git Flow Validation: $git_flow_status"
          echo "Structure Validation: $structure_status"
          echo "Frontend (Next.js): $frontend_status"
          echo ".NET Services: $dotnet_status"
          echo "Python/DSPy: $python_status"
          echo "Inference Engine: $inference_status"
          echo ""

          # Check for failures
          if [[ "$structure_status" != "success" ]]; then
            echo "❌ CI Pipeline FAILED - Structure validation failed"
            exit 1
          fi

          # Allow skipped jobs (when paths don't match)
          failed=false
          if [[ "$frontend_status" == "failure" ]]; then
            echo "❌ Frontend build failed"
            failed=true
          fi
          if [[ "$dotnet_status" == "failure" ]]; then
            echo "❌ .NET build failed"
            failed=true
          fi
          if [[ "$python_status" == "failure" ]]; then
            echo "❌ Python build failed"
            failed=true
          fi
          if [[ "$inference_status" == "failure" ]]; then
            echo "❌ Inference engine build failed"
            failed=true
          fi

          if [[ "$failed" == "true" ]]; then
            echo ""
            echo "❌ CI Pipeline FAILED"
            exit 1
          fi

          echo "✅ CI Pipeline PASSED"
